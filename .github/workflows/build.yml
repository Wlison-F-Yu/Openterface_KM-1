name: Build Openterface Keyboard and Mouse emulator firmware

on:
  push:
    branches:
      - main

env:
  SOURCE_DIR: ${{ github.workspace }}
  BUILD_DIR: ${{ github.workspace }}\build
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  RISC_COMPILER_VERSION: 8.2.0-3.1.1

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Cache chocolatey packages
      uses: actions/cache@v3
      with:
        path: C:\ProgramData\chocolatey\lib
        key: ${{ runner.os }}-choco-${{ hashFiles('**/build.yml') }}
        restore-keys: |
          ${{ runner.os }}-choco-

    - name: Install build dependencies
      run: |
        choco install -y make wget unzip
        echo "C:\\ProgramData\\chocolatey\\bin" >> $GITHUB_PATH

    - name: Cache RISC-V compiler
      uses: actions/cache@v3
      id: cache-risc-compiler
      with:
        path: C:\tools\risc-none-embed-gcc
        key: ${{ runner.os }}-risc-compiler-${{ env.RISC_COMPILER_VERSION }}

    - name: Check cache status
      run: |
        if ("${{ steps.cache-risc-compiler.outputs.cache-hit }}" -eq "true") {
          Write-Host "✓ Cache HIT: Using cached RISC-V compiler" -ForegroundColor Green
        } else {
          Write-Host "✗ Cache MISS: Downloading fresh RISC-V compiler" -ForegroundColor Yellow
        }

    - name: Clone risc-none-embed-gcc and configure environment
      if: steps.cache-risc-compiler.outputs.cache-hit != 'true'
      run: |
        wget https://github.com/openwch/risc-none-embed-gcc/archive/refs/tags/8.2.0.zip 
        unzip 8.2.0.zip
        move risc-none-embed-gcc-8.2.0 c:\\tools\\risc-none-embed-gcc

    - name: Configure compiler environment
      run: |
        echo "RISC_COMPILER_PATH=C:\\tools\\risc-none-embed-gcc\\risc-none-embed-gcc-${{ env.RISC_COMPILER_VERSION }}" >> $GITHUB_ENV
        echo "C:\\tools\\risc-none-embed-gcc\\bin" >> $GITHUB_PATH
        echo "RISC_COMPILER_PATH=C:\\tools\\risc-none-embed-gcc" >> $GITHUB_ENV

    - name: Build the project
      run: |
        echo "Starting build process..."
        echo "Compiler path: $env:RISC_COMPILER_PATH"
        cd build
        $env:PATH = "C:\tools\risc-none-embed-gcc\bin;" + $env:PATH
        $env:RISC_COMPILER_PATH = "C:\tools\risc-none-embed-gcc"
        riscv-none-embed-gcc --version
        make clean
        make -j4 all
        if ($LASTEXITCODE -eq 0) {
          Write-Host "✓ Build succeeded" -ForegroundColor Green
        } else {
          Write-Host "✗ Build failed with exit code $LASTEXITCODE" -ForegroundColor Red
          exit 1
        }

    - name: Save build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: openterface-km-firmware.hex
        if-no-files-found: error
        path: |
          ${{ env.BUILD_DIR }}\openterface-km-firmware.hex
